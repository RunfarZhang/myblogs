# DHCP部署与安全

---

## DHCP作用

* 自动分配IP地址

## DHCP相关概念

* *Dynamic Host Configure Protocol*

* 地址池/作用域：（IP、子网掩码、网关、DNS、租期）
* DHCP协议端口是UDP 67/68

## DHCP优点

* 减少工作量
* 避免IP冲突
* 提高地址利用率

## **DHCP原理**

* 也称为DHCP租约过程，分为以下4个步骤：
  1. *客户机发送DHCP Discovery广播包*
     * *客户机广播请求IP地址（包含客户机的MAC地址）*
  2. *服务器相应DHCP Offer广播包*
     * *服务器相应提供的IP地址（但无子网掩码、网关等参数）*
  3. *客户机发送DHCP Request广播包*
     * *客户机选择IP（也可以认为确认使用哪个IP）*
  4. *服务器发送DHCP ACK广播包*
     * *服务器确定了租约，并提供网卡详细参数IP、掩码、网关、DNS、租期等*

## *DHCP续约*

* *当过了合约时间一半时，客户机再次发送DHCP Request包，此时表示需要续约。在接到服务器的ACK包后，从现在起重新进行合约计时*
* *若服务器未响应，则继续使用并在87.5%使再次发送DHCP Request包，如果仍未响应，则发送DHCP Discovery广播包*

* *当无任何服务器响应是，网卡会自动分配一个169.254.x.x/16，该地址属于全球统一的无效地址，可以临时解决内网通信问题*

## **部署DHCP服务器**

1. IP地址固定（服务器必须固定IP地址）
2. 安装DHCP服务插件
3. 服务器ip地址应当是静态的，地址预留给服务器
4. 部署地址池/作用域（每个Vmware虚拟机都会自带DHCP服务器，需要屏蔽）
5. 详细信息里的ID就是客户机的MAC地址（000xxxxxxxxx）

* 服务器ip要与地址池ip一致

## 相关命令

* ipconfig--查看本地ip信息，
  * /all：查看详细信息，
  * /release：释放ip或者改为手动配置ip，也可以释放租约，
  * /renew：在没有租约时发送discovery广播包，在有租约时发送request包手工续约
* netstat
  * -an：查看开放的端口

## 地址保留

* *手工配置ip可能在更换局域网后无法上网*，需要**保留**操作。
* 即对于指定的MAC地址，固定地动态分配IP地址。

## DHCP备份

* *同一台服务器上可以存在多个地址池，建议做备份*

## *选项优先级*

* 服务器选项优先级高于作用域选项。
* 每个作用域选项相同的部分（DNS）可以在服务器选项里统一做，不同的部分（路由器）必须分别在作用域选项里配置。
* 若作用域里不配置选项，则继承总的服务器选项；若单独配置了作用域选项，则根据单独的作用域选项进行操作。*即作用域选项优先级高于服务器选项*

## **DHCP攻击与防御**

1. 攻击DHCP服务器：频繁发送伪装的（假MAC地址）DHCP请求，直到将DHCP地址池资源耗尽。
   * 防御：在交换机（管理型）端口上做动态MAC地址绑定；静态绑定（端口与MAC绑定）应用于安全性较高的场所。

2. 伪装DHCP服务器攻击客户机：hacker通过将自己部署为DHCP服务器，为客户机提供非法ip地址。
   * 防御：在交换机上（管理型），除合法的DHCP服务器所在接口外，全部设置为禁止dhcp offer包。